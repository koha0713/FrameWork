// ===================================================================
// BitmapFontManager.h
// 複数のビットマップフォントを管理するマネージャークラス
// シングルトンパターンで実装
// ===================================================================
#pragma once
#include "BitmapFont.h"
#include "singleton.h"
#include <memory>
#include <unordered_map>
#include <string>

// ===================================================================
// FontID 列挙型
// 各フォント画像を識別するためのID
// ===================================================================
enum class FontID
{
    HIRAGANA,       // ひらがな
    KATAKANA,       // カタカナ
    ALPHANUMERIC,   // 英数字・記号
    SYMBOL,         // 記号
    KANJI_1,        // 漢字セット1

    // 将来の拡張用
    // KANJI_2,
    // KANJI_3,

    MAX             // 最大数（配列サイズ用）
};

// ===================================================================
// BitmapFontManager クラス
// 複数のBitmapFontを統合管理し、文字検索を提供
// ===================================================================
class BitmapFontManager
{
public:
    // ===================================================================
    // CharInfo 構造体（BitmapFont::CharInfo のエイリアス）
    // UITextComponentから使用するための公開型
    // ===================================================================
    using CharInfo = BitmapFont::CharInfo;

private:
    // ===================================================================
    // メンバ変数
    // ===================================================================

    // 各フォントの実体
    std::unordered_map<FontID, std::unique_ptr<BitmapFont>> m_Fonts;

    // 文字→フォント情報のマップ（高速検索用）
    std::unordered_map<wchar_t, const CharInfo*> m_CharMap;

    // 初期化フラグ
    bool m_Initialized;

public:
    // ===================================================================
    // コンストラクタ・デストラクタ
    // ===================================================================
    BitmapFontManager();
    ~BitmapFontManager() = default;

    // ===================================================================
    // ライフサイクル
    // ===================================================================

    /**
     * @brief 初期化（全フォントを読み込み）
     */
    void Init();

    /**
     * @brief 終了処理
     */
    void Uninit();

    // ===================================================================
    // フォント登録
    // ===================================================================

    /**
     * @brief フォントを登録
     * @param fontId フォントID
     * @param texturePath テクスチャファイルパス
     * @param charSet 文字セット（L"あいうえお..."）
     * @param charWidth 1文字の幅（ピクセル）
     * @param charHeight 1文字の高さ（ピクセル）
     * @param columns グリッドの列数
     * @param rows グリッドの行数
     * @return 成功したらtrue
     */
    bool RegisterFont(
        FontID fontId,
        const std::string& texturePath,
        const std::wstring& charSet,
        int charWidth,
        int charHeight,
        int columns,
        int rows
    );

    // ===================================================================
    // 文字検索
    // ===================================================================

    /**
     * @brief 文字情報を検索
     * @param ch 検索する文字
     * @return 文字情報のポインタ（見つからない場合はnullptr）
     */
    const CharInfo* FindChar(wchar_t ch) const;

    /**
     * @brief 初期化済みかチェック
     * @return 初期化済みならtrue
     */
    bool IsInitialized() const { return m_Initialized; }

private:
    // ===================================================================
    // 内部処理
    // ===================================================================

    /**
     * @brief 文字マップを構築（全フォントから）
     */
    void BuildCharMap();
};

// ===================================================================
// シングルトンアクセス用マクロ
// ===================================================================
#define BITMAP_FONT_MANAGER Singleton<BitmapFontManager>::GetInstance()